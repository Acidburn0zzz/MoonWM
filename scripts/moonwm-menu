#!/bin/sh

HINT_TIME=2000

rightmenu="  Applications
$(moonwm-xdg-xmenu -l | sed -e 's/^/	/')

  Shutdown			poweroff || sudo poweroff
  Reboot			reboot || sudo reboot
  Suspend			moonwm-util lock; loginctl suspend || systemctl suspend

  Reload MoonWM	moonie restartlaunched
  Log out			moonie quit"

appsmenu="  Terminal			$TERMINAL"
command -v $BROWSER > /dev/null 2>&1    && appsmenu="$appsmenu
  Web				$BROWSER"
command -v mpv > /dev/null 2>&1         && appsmenu="$appsmenu
  Media			mpv"
command -v $FILEMANAGER > /dev/null 2>&1 && appsmenu="$appsmenu
  Files			$FILEMANAGER"
command -v discord > /dev/null 2>&1     && appsmenu="$appsmenu
ﭮ  Discord			discord"
command -v discord-canary > /dev/null 2>&1     && appsmenu="$appsmenu
ﭮ  Discord [c]		discord-canary"
command -v spotify > /dev/null 2>&1     && appsmenu="$appsmenu
  Spotify			if pidof spotify; then moonie toggleview 7; else spotify; fi"
command -v thunderbird > /dev/null 2>&1 && appsmenu="$appsmenu
  Mail				thunderbird"

contextmenu="  Close			close
ﭔ  Resize			resize
  Floating			float
  Fullscreen		fullscreen

   More
	  Close multiple		closemult
	  Kill process			kill"

context () {
    selection="$(printf "$contextmenu" | xmenu -i)"
    [ -z "$selection" ] && exit
    if [ "$1" = select ] && [ "$selection" != closemult ]; then
        case $selection in
            close)
                notify-send -t "$HINT_TIME" \
                    -a "MoonWM - Close" "Select a window to close"
                xsetroot -name "Select a window to close"
                ;;
            resize)
                notify-send -t "$HINT_TIME" \
                    -a "MoonWM - Resize" "Select a window to resize"
                xsetroot -name "Select a window to resize"
                ;;
            float)
                notify-send -t "$HINT_TIME" \
                    -a "MoonWM - Float" "Select a window to float/unfloat"
                xsetroot -name "Select a window to resize"
                ;;
            fullscreen)
                notify-send -t "$HINT_TIME"
                    -a "MoonWM - Fullscreen" "Select a window to enter/leave fullscreen"
                xsetroot -name "Select a window to resize"
                ;;
            kill)
                notify-send -t "$HINT_TIME" \
                    -a "MoonWM - Kill" "Select a window to kill its process"
                xsetroot -name "Select a window to resize"
                ;;
            closemult)
                notify-send -t "$HINT_TIME" \
                    -a "MoonWM - Close Multiple" "Select multiple windows close. Exit with <Escape> or right click."
                xsetroot -name "Select a window to resize"
                ;;
        esac
        wid="$(slop -b 0 -f %i)"
        [ -z "$wid" ] && exit
        timeout -k 3s 3s xdotool windowactivate --sync "$wid" || exit
    fi
    case $selection in
        close) moonie killclient ;;
        resize) moonie rioresize ;;
        float) moonie togglefloating ;;
        fullscreen) moonie togglefullscr ;;
        kill) kill "$(xdotool getwindowfocus getwindowpid)" ;;
        closemult)
            while [ 1 = 1 ]; do
                wid="$(slop -b 0 -f %i)"
                [ -z "$wid" ] && exit
                timeout -k 3s 3s xdotool windowclose "$wid"
            done
            ;;
    esac
}

layouts () {
    moonie setlayout "$(layouts_classic)"
}

layouts_classic () {
    moonie printlayouts | nl -v0 -w1 | sed 's/\s*[a-z]*$//;s/\([[:digit:]]*\)\t\(.*\)/\2\t\1/' | xmenu -i
}

menupos () {
    if ! [ "$MOONWM_TOPBAR" = 0 ]; then
        echo -p 0x0:current
    fi
}


case $1 in
    # 1) rofi -show drun -config ~/.config/rofi/apps.rasi -fullscreen ;;
    # 1) moonwm-xdg-xmenu | xmenu -p 0x0 | sh ;;
    1) pidof skippy-xd || skippy-xd > /dev/null 2>&1 ;;
    2) echo "$appsmenu" | xmenu -i $(menupos) | sh ;;
    3) echo "$rightmenu" | xmenu $(menupos) | sh ;;
    context) context select ;;
    context-client) context client ;;
    context-select) context select ;;
    layouts)
        layouts ;;
    layouts-classic)
        layouts_classic ;;
esac

