#!/bin/sh

rightmenu="  Applications
$(moonwm-xdg-xmenu -l | sed -e 's/^/	/')

  Shutdown			poweroff || sudo poweroff
  Reboot			reboot || sudo reboot
  Suspend			moonwm-util lock; loginctl suspend || systemctl suspend

  Reload MoonWM	moonctl restartlaunched
  Log out			moonctl quit"

appsmenu="  Terminal			$TERMINAL"
command -v $BROWSER > /dev/null 2>&1    && appsmenu="$appsmenu
  Web				$BROWSER"
command -v mpv > /dev/null 2>&1         && appsmenu="$appsmenu
  Media			mpv"
command -v $FILEMANAGER > /dev/null 2>&1 && appsmenu="$appsmenu
  Files			$FILEMANAGER"
command -v discord > /dev/null 2>&1     && appsmenu="$appsmenu
ﭮ  Discord			discord"
command -v discord-canary > /dev/null 2>&1     && appsmenu="$appsmenu
ﭮ  Discord [c]		discord-canary"
command -v spotify > /dev/null 2>&1     && appsmenu="$appsmenu
  Spotify			if pidof spotify; then moonctl toggleview 7; else spotify; fi"
command -v thunderbird > /dev/null 2>&1 && appsmenu="$appsmenu
  Mail				thunderbird"

contextmenu="  Close			close
ﭔ  Resize			resize
  Floating			float
  Fullscreen		fullscreen

   More
	  Center				center
	  Close multiple		closemult
	  Reset size hints		resetfacts
	  Kill process			kill"


important_msg () {
    xsetroot -name "important:$1 "
}

important_msg_close () {
    xsetroot -name "important:close"
    command -v "$MOONWM_STATUSCMD" 2>/dev/null \
        && "$MOONWM_STATUSCMD" update
}

context () {
    selection="$(printf "$contextmenu" | xmenu -i)"
    [ -z "$selection" ] && exit
    if [ "$1" = select ] && [ "$selection" != closemult ] && [ "$selection" != resetfacts ]; then
        case $selection in
            close)
                important_msg "Select a window to close." ;;
            resize)
                important_msg "Select a window to resize." ;;
            float)
                important_msg "Select a window to float/unfloat." ;;
            fullscreen)
                important_msg "Select a window enter/exit fullscreen." ;;
            kill)
                important_msg "Select a window to kill its process." ;;
            center)
                important_msg "Select a window to center" ;;
        esac
        # select window
        wid="$(slop -b 0 -f %i)"
        important_msg_close
        [ -z "$wid" ] && exit
        moonctl activate "$wid" || exit
    fi
    case $selection in
        close) moonctl killclient ;;
        resize) moonctl rioresize ;;
        float) moonctl togglefloating ;;
        fullscreen) moonctl togglefullscr ;;
        kill) sleep 0.25; kill "$(xdotool getwindowfocus getwindowpid)" ;;
        center) moonctl center ;;
        resetfacts) moonctl resetfacts 0 ;;
        closemult)
            while [ 1 = 1 ]; do
                important_msg "Select multiple windows to close; Exit with <Esc> or right click."
                wid="$(slop -b 0 -f %i)"
                important_msg_close
                [ -z "$wid" ] && exit
                timeout -k 3s 3s xdotool windowclose "$wid"
            done
            ;;
    esac
}

layouts () {
    moonctl setlayout "$(layouts_classic)"
}

layouts_classic () {
    moonctl printlayouts | nl -v0 -w1 | sed 's/\s*[a-z]*$//;s/\([[:digit:]]*\)\t\(.*\)/\2\t\1/' | xmenu -i
}

menupos () {
    if ! [ "$MOONWM_TOPBAR" = 0 ]; then
        echo -p 0x0:current
    fi
}


case $1 in
    # 1) rofi -show drun -config ~/.config/rofi/apps.rasi -fullscreen ;;
    # 1) moonwm-xdg-xmenu | xmenu -p 0x0 | sh ;;
    1) pidof skippy-xd || skippy-xd > /dev/null 2>&1 ;;
    2) echo "$appsmenu" | xmenu -i $(menupos) | sh ;;
    3) echo "$rightmenu" | xmenu $(menupos) | sh ;;
    context) context select ;;
    context-client) context client ;;
    context-select) context select ;;
    layouts)
        layouts ;;
    layouts-classic)
        layouts_classic ;;
esac

